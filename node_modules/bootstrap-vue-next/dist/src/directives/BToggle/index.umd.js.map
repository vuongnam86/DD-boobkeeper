{"version":3,"file":"index.umd.js","sources":["../../../../src/directives/BToggle/index.ts"],"sourcesContent":["import {RX_HASH, RX_HASH_ID, RX_SPACE_SPLIT} from '../../utils/constants'\nimport {type Directive, type DirectiveBinding, type VNode} from 'vue'\nimport {findProvides} from '../utils'\nimport {type RegisterShowHideValue, showHideRegistryKey} from '../../utils/keys'\nimport {getActiveShowHide} from '../../utils/registryAccess'\n\nconst getTargets = (\n  binding: DirectiveBinding<string | readonly string[] | undefined>,\n  el: Readonly<Element>\n) => {\n  const {modifiers, arg, value} = binding\n  // Any modifiers are considered target Ids\n  const targets = Object.keys(modifiers || {})\n\n  // If value is a string, split out individual targets (if space delimited)\n  const localValue = typeof value === 'string' ? value.split(RX_SPACE_SPLIT) : value\n\n  // Support target Id as link href (`href=\"#id\"`)\n  if (el.tagName.toLowerCase() === 'a') {\n    const href = el.getAttribute('href') || ''\n    if (RX_HASH_ID.test(href)) {\n      targets.push(href.replace(RX_HASH, ''))\n    }\n  }\n\n  // Add Id from `arg` (if provided), and support value\n  // as a single string Id or an array of string Ids\n  // If `value` is not an array or string, then it gets filtered out\n  Array.prototype.concat\n    .apply([], [arg, localValue])\n    .forEach((t) => typeof t === 'string' && targets.push(t))\n\n  // Return only unique and truthy target Ids\n  return targets.filter((t, index, arr) => t && arr.indexOf(t) === index)\n}\n\nconst handleUpdate = (\n  el: Element,\n  binding: DirectiveBinding<string | readonly string[] | undefined>,\n  vnode: VNode\n) => {\n  // Determine targets\n  const targets = getTargets(binding, el)\n  if (targets.length === 0) return\n\n  const provides = findProvides(binding, vnode)\n  const showHideMap =\n    (provides as Record<symbol, RegisterShowHideValue>)[showHideRegistryKey]?.values ?? null\n  if ((el as HTMLElement).dataset.bvtoggle) {\n    const oldTargets = ((el as HTMLElement).dataset.bvtoggle || '').split(' ')\n    if (oldTargets.length === 0) return\n    for (const targetId of oldTargets) {\n      const showHide = getActiveShowHide(showHideMap, targetId)\n      if (!showHide) {\n        continue\n      }\n      if (!targets.includes(targetId)) {\n        showHide.unregisterTrigger('click', el, false)\n      }\n    }\n  }\n  ;(el as HTMLElement).dataset.bvtoggle = targets.join(' ')\n\n  targets.forEach(async (targetId) => {\n    let count = 0\n    const maxAttempts = 5\n    const delayMs = 100\n\n    // Keep looking until showHide is found, giving up after 500ms or directive is unmounted\n    while (count < maxAttempts) {\n      // Check if element is still mounted before each iteration\n      if (!(el as HTMLElement).dataset.bvtoggle) {\n        // Element was unmounted, stop trying\n        return\n      }\n\n      const showHide = getActiveShowHide(showHideMap, targetId)\n      if (!showHide) {\n        count++\n        if (count < maxAttempts) {\n          await new Promise((resolve) => setTimeout(resolve, delayMs))\n          continue\n        }\n        // Only warn if element is still mounted after all attempts\n        if ((el as HTMLElement).dataset.bvtoggle) {\n          // eslint-disable-next-line no-console\n          console.warn(\n            `[v-b-toggle] Target with ID ${targetId} not found after ${maxAttempts * delayMs}ms`\n          )\n        }\n        break\n      }\n\n      // Final check before registration\n      if (!(el as HTMLElement).dataset.bvtoggle) return\n\n      // Register the trigger element\n      showHide.unregisterTrigger('click', el, false)\n      showHide.registerTrigger('click', el)\n      break\n    }\n  })\n\n  el.setAttribute('aria-controls', targets.join(' '))\n}\nconst handleUnmount = (\n  el: Element,\n  binding: DirectiveBinding<string | readonly string[] | undefined>,\n  vnode: VNode\n) => {\n  // Determine targets\n  const targets = getTargets(binding, el)\n  if (targets.length === 0) return\n  const provides = findProvides(binding, vnode)\n  const showHideMap =\n    (provides as Record<symbol, RegisterShowHideValue>)[showHideRegistryKey]?.values ?? null\n\n  targets.forEach((targetId) => {\n    const showHide = getActiveShowHide(showHideMap, targetId)\n    if (!showHide) {\n      return\n    }\n    // Pass clean=true to let the composable handle cleanup of aria-expanded and classes\n    showHide.unregisterTrigger('click', el, true)\n  })\n\n  // Only remove what the directive manages (aria-controls)\n  // aria-expanded and classes are managed by useShowHide composable\n  el.removeAttribute('aria-controls')\n  delete (el as HTMLElement).dataset.bvtoggle\n}\n\nexport const vBToggle: Directive<Element> = {\n  mounted: handleUpdate,\n  updated: handleUpdate,\n  unmounted: handleUnmount,\n}\n"],"names":["getTargets","binding","el","modifiers","arg","value","targets","Object","keys","localValue","split","RX_SPACE_SPLIT","tagName","toLowerCase","href","getAttribute","RX_HASH_ID","test","push","replace","RX_HASH","Array","prototype","concat","apply","forEach","t","filter","index","arr","indexOf","handleUpdate","vnode","length","provides","findProvides","showHideMap","showHideRegistryKey","values","dataset","bvtoggle","oldTargets","targetId","showHide","getActiveShowHide","includes","unregisterTrigger","join","async","count","Promise","resolve","setTimeout","console","warn","registerTrigger","setAttribute","vBToggle","mounted","updated","unmounted","removeAttribute"],"mappings":"uRAMMA,EAAa,CACjBC,EACAC,KAEA,MAAMC,UAACA,EAAAC,IAAWA,EAAAC,MAAKA,GAASJ,EAE1BK,EAAUC,OAAOC,KAAKL,GAAa,CAAA,GAGnCM,EAA8B,iBAAVJ,EAAqBA,EAAMK,MAAMC,EAAAA,gBAAkBN,EAG7E,GAAiC,MAA7BH,EAAGU,QAAQC,cAAuB,CACpC,MAAMC,EAAOZ,EAAGa,aAAa,SAAW,GACpCC,EAAAA,WAAWC,KAAKH,IAClBR,EAAQY,KAAKJ,EAAKK,QAAQC,EAAAA,QAAS,IAEvC,CAUA,OALAC,MAAMC,UAAUC,OACbC,MAAM,GAAI,CAACpB,EAAKK,IAChBgB,QAASC,GAAmB,iBAANA,GAAkBpB,EAAQY,KAAKQ,IAGjDpB,EAAQqB,OAAO,CAACD,EAAGE,EAAOC,IAAQH,GAAKG,EAAIC,QAAQJ,KAAOE,IAG7DG,EAAe,CACnB7B,EACAD,EACA+B,KAGA,MAAM1B,EAAUN,EAAWC,EAASC,GACpC,GAAuB,IAAnBI,EAAQ2B,OAAc,OAE1B,MAAMC,EAAWC,EAAAA,aAAalC,EAAS+B,GACjCI,EACHF,EAAmDG,wBAAsBC,QAAU,KACtF,GAAKpC,EAAmBqC,QAAQC,SAAU,CACxC,MAAMC,GAAevC,EAAmBqC,QAAQC,UAAY,IAAI9B,MAAM,KACtE,GAA0B,IAAtB+B,EAAWR,OAAc,OAC7B,IAAA,MAAWS,KAAYD,EAAY,CACjC,MAAME,EAAWC,EAAAA,kBAAkBR,EAAaM,GAC3CC,IAGArC,EAAQuC,SAASH,IACpBC,EAASG,kBAAkB,QAAS5C,GAAI,GAE5C,CACF,CACEA,EAAmBqC,QAAQC,SAAWlC,EAAQyC,KAAK,KAErDzC,EAAQmB,QAAQuB,MAAON,IACrB,IAAIO,EAAQ,EAKZ,KAAOA,EAJa,GAIQ,CAE1B,IAAM/C,EAAmBqC,QAAQC,SAE/B,OAGF,MAAMG,EAAWC,EAAAA,kBAAkBR,EAAaM,GAChD,IAAKC,EAAU,CAEb,GADAM,IACIA,EAdY,EAcS,OACjB,IAAIC,QAASC,GAAYC,WAAWD,EAdhC,MAeV,QACF,CAEKjD,EAAmBqC,QAAQC,UAE9Ba,QAAQC,KACN,+BAA+BZ,2BAGnC,KACF,CAGA,IAAMxC,EAAmBqC,QAAQC,SAAU,OAG3CG,EAASG,kBAAkB,QAAS5C,GAAI,GACxCyC,EAASY,gBAAgB,QAASrD,GAClC,KACF,IAGFA,EAAGsD,aAAa,gBAAiBlD,EAAQyC,KAAK,OA6BnCU,EAA+B,CAC1CC,QAAS3B,EACT4B,QAAS5B,EACT6B,UA9BoB,CACpB1D,EACAD,EACA+B,KAGA,MAAM1B,EAAUN,EAAWC,EAASC,GACpC,GAAuB,IAAnBI,EAAQ2B,OAAc,OAC1B,MAAMC,EAAWC,EAAAA,aAAalC,EAAS+B,GACjCI,EACHF,EAAmDG,wBAAsBC,QAAU,KAEtFhC,EAAQmB,QAASiB,IACf,MAAMC,EAAWC,EAAAA,kBAAkBR,EAAaM,GAC3CC,GAILA,EAASG,kBAAkB,QAAS5C,GAAI,KAK1CA,EAAG2D,gBAAgB,wBACX3D,EAAmBqC,QAAQC"}